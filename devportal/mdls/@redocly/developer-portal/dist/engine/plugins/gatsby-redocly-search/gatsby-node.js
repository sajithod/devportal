const path=require("path"),fs=require("fs"),cheerio=require("cheerio"),elasticlunr=require("elasticlunr"),shortid=require("shortid"),{contentDigest}=require("../gatsby-source-redocly-filesystem/utils"),{ProStore}=require("@redocly/reference-docs"),{DeepSearchIndexer}=require("./DeepSearchIndexer"),{PAGE_TYPES}=require("../../constants");async function readFileAsync(a,b){return new Promise(function(c,d){fs.readFile(a,b,function(a,b){a?d(a):c(b)})})}function initSearchIndex(){elasticlunr.tokenizer.setSeperator(/[\s\-.\/]+/g);const a=elasticlunr();return a.setRef("id"),a.addField("content"),a.addField("title"),a}async function saveSearchIndex(a,b){let c;try{c=JSON.stringify(a.toJSON())}catch(a){if("RangeError"===a.name)throw new Error("Error creating search index: some of your content files probably contain very long non-breaking lines. Please, try to add spaces or line breaks or contact team@redoc.ly");throw a}return new Promise((a,d)=>{fs.writeFile(path.resolve(b+path.sep+"search-index.json"),c,"utf8",b=>b?(console.log("Search index generation failed",b),void d(b)):void(console.log("Search index generated and saved successfully"),a()))})}function parseHeadings(a,b,c){let d,e;const f=a("nav a").toArray().map(b=>({href:a(b).attr("href"),title:a(b).text()}));if(a("aside").length){const g=a("aside a").toArray().map(b=>({href:a(b).attr("href"),title:a(b).find("> div > span").text(),element:b}));for(let a of f)if(g.find(b=>b.href===a.href)){d=a.title;break}const h=g.find(a=>a.href===b);if(e=h&&h.title,e===c){const b=a(h.element).closest("ul").parent().prev().children().first().text();b&&(e=b)}}else{const a=f.find(a=>a.href===b);d=a&&a.title}return{group:d,side:e}}exports.onPostBuild=async({graphql:a},b,c)=>{const{publicDir:d}=b,e={},f=await a(`
    {
      allContentItem(filter: { data: { excludeFromSearch: { ne: true } } }) {
        edges {
          node {
            id
            link
            data {
              redocStoreStr
              redocItemId
              redocPagination
              lastModified
              settings
            }
            seo {
              title
            }
            type
          }
        }
      }
    }
  `),g=initSearchIndex(),h=new DeepSearchIndexer({});return await Promise.all(f.data.allContentItem.edges.map(async({node:{link:a,type:b,data:{redocStoreStr:c,redocItemId:f,redocPagination:i,settings:j},seo:{title:k}}})=>{function l(b,c){return[(k||a)+(b.length?` > ${c}`:"")].filter(Boolean)}function m(b){return b.length?`${a}#${r(b).find(".hidden-anchor").attr("id")}`:a}function n(b){g.addDoc({id:a+"#"+b.id+shortid.generate(),link:a+"#"+b.id,headings:[b.name].filter(Boolean),title:b.name,content:b.name+"\n"+b.description,meta:{}})}function o(b){g.addDoc({id:a+"#"+b.id+shortid.generate(),link:a,headings:[b.name].filter(Boolean),title:b.name,content:b.name+"\n"+(b.description||"")})}function p(b,c){h.indexOperation(b,(d,e,f)=>{const h=d===b.name;g.addDoc({id:a+"#"+b.id+shortid.generate(),link:"item"===c?a:a+"#"+b.id,headings:[b.name].filter(Boolean),title:h?d:"",content:d+"\n"+e,httpVerb:b.httpVerb,meta:{place:f.place,path:f.path}})})}if(h.setOptions(j||{}),b===PAGE_TYPES.referenceDocsContainerPage)return;if(c){const d=contentDigest(c);if(!e[d]){const a=JSON.parse(c);a.options.disableSearch=!0,a.options.ctrlFHijack=!1,a.options.showNextButton=!1,e[d]=ProStore.fromJS(a)}const h=e[d];if(b===PAGE_TYPES.referenceDocsOverview){g.addDoc({id:a+"#"+shortid.generate(),link:a,headings:[k].filter(Boolean),title:k,content:k+"\n"+(h.definition||h.spec).info.description,meta:{}});for(const a of h.menu.flatItems){if("section"!==a.type&&"none"!==i)break;"tag"===a.type?o(a):"operation"===a.type?p(a,"none"):"section"===a.type&&n(a)}return}let j=[];if(b===PAGE_TYPES.referenceDocsPage&&h.menu.flatItems.length){const a=h.menu.flatItems.find(a=>a.id===f);"tag"===a.type?"section"===i?j.push(a,...a.items):"item"===i&&j.push(a,...a.items.filter(a=>"section"===a.type)):"operation"===a.type&&j.push(a)}else"operation"===redocItem.type&&j.push(redocItem);for(const a of j)"tag"===a.type&&a.description?o(a):"operation"===a.type?p(a,i):"section"===a.type&&n(a);return}let q=await readFileAsync(path.resolve(d+path.sep+a+path.sep+"index.html"),"utf8"),r=cheerio.load(q);r("article").find("table span.field-name").each((a,b)=>{const c=r(".hidden-anchor[id]").first().parent(),d=r(b)[0].children[0],e=d.data,f={id:shortid.generate(),link:m(c),headings:l(c,e),title:e,content:e};g.addDoc(f)}),r("article > h1, article > h2,article > h3,article > h4, article > p, article > ul, article > div, article > ol").each((a,b)=>{const c=r(b)[0].tagName,d="h1"===c||"h2"===c||"h3"===c||"h4"===c?r(b):r(b).prevAll(".hidden-anchor[id]").first().parent(),e={id:shortid.generate(),link:m(d),headings:l(d,d.text()),title:k,content:r(b).text()};g.addDoc(e)})})),await saveSearchIndex(g,d),c(),g};