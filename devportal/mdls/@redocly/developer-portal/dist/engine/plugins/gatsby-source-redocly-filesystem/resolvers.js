const chalk=require("chalk"),fs=require("fs"),path=require("path"),RBAC=require("./rbac"),{getRedocStoreById}=require("./oas/cache"),{isYamlBasedPage,YAML_PAGE_EXTENSION,copyFile,copyReferencedFiles}=require("./utils"),{getPageInfo,getAllPagesInfo}=require("./pages/cache"),{PAGE_TYPES}=require("../../constants");exports.createResolvers=(a,b)=>{const{defaultRbacPermission:c}=b.getSiteConfig(),d=b.configPath;a.createResolvers({ContentItemSeo:{image:{resolve:(b,c,e)=>{if(!b.image)return"";const f=copyReferencedFiles(b,{context:e,...a},d,d);return f.image}}},ContentItemData:{customDataString:{resolve:(b,c,e)=>{if(!b.sourcePath)return b.customDataString||"";if(!b.customDataString)return"";const f=JSON.parse(b.customDataString),g=copyReferencedFiles(f,{context:e,...a},path.dirname(b.sourcePath),d);return JSON.stringify(g)}}},Query:{apis:{resolve:(a,b)=>{let d=getAllPagesInfo().filter(a=>a.type===PAGE_TYPES.referenceDocsContainerPage);b.ignoreRBAC||"development"===process.env.NODE_ENV||(d=d.filter(a=>{const b=a.permission||RBAC.GUEST_PERMISSION;return b===RBAC.GUEST_PERMISSION}));const e=[...(b.definitionProperties||[]),"x-categories","x-tags"],f=d.filter(a=>a.isDefaultApiVersion).map(a=>{const b=a.apiVersions.find(a=>a.isDefault).definitionId,f=getRedocStoreById(b),g=f&&f.redocStore.definition.parser.definition;if(!g)return null;const h=e.reduce((a,b)=>(a[b]=g[b],a),{});return{id:a.id,definitionId:b,versions:a.apiVersions.map(b=>{const c=d.find(c=>c.apiVersionId===b.id&&c.pageId.split("@")[0]===a.pageId.split("@")[0]);return{...b,link:c&&c.link}}),sourcePath:a.sourcePath,link:a.link,info:g.info,title:a.title||a.label||g.info.title,definitionProperties:h,permission:a.permission||c,data:{...a.rawData,redocStore:void 0,redocMenuItems:void 0,redocItemId:void 0,customDataString:void 0,customTemplate:void 0,requestLogin:void 0}}}).filter(Boolean);return f.sort((c,a)=>c&&a&&c.definitionId.localeCompare(a.definitionId)),f}},oasDefinition:{resolve:(a,b)=>{const c=getRedocStoreById(b.id);return{...c,redocStore:c&&c.redocStoreStr}}}},SiteSiteMetadata:{image:{resolve:(b,c,e)=>{const f=b.image;return copyFile(f,{context:e,...a},d,d)}}},SiteConfig:{footer:{resolve:a=>a.raw.footer},logo:{resolve:(b,c,e)=>{const f=b.raw.logo||{},g=b.raw.seo||{},h="string"==typeof f;b.raw.headerIcon&&console.warn("\"headerIcon\" is deprecated, use it inside the \"logo.image\" instead"),g.logoHref&&console.warn("\"logoHref\" is deprecated, use it inside the \"logo.href\" instead"),g.logoAltText&&console.warn("\"logoAltText\" is deprecated, use it inside the \"logo.altText\" instead"),h&&console.warn("\"logo\" as a string is deprecated, use it inside the \"logo.image\" instead");const i=f.image||h&&f||b.raw.headerIcon;return{image:copyFile(i,{context:e,...a},d,d),href:f.href||g.logoHref||"/",altText:f.altText||g.logoAltText}}},scripts:{resolve:(b,c,e)=>{const f=b.raw.scripts||[];return f.map(b=>copyFile(b,{context:e,...a},d,d)).filter(a=>!!a)}},nav:{resolve:(a,{ignoreRBAC:b})=>a.raw.nav?a.raw.nav.filter(a=>{const d=getPageInfo(a.page),e=a.page&&d?getPageInfo(a.page).permission:void 0,f=a.permission||e||c,g="development"===process.env.NODE_ENV||b;return g||f===RBAC.GUEST_PERMISSION}):[]},enableToc:{resolve:a=>a.raw.enableToc||!1},disableLastModified:{resolve:a=>a.raw.disableLastModified||!1},tocMaxDepth:{resolve:a=>a.raw.tocMaxDepth||4},toc:{resolve:a=>({enable:a.raw.toc&&a.raw.toc.hasOwnProperty("enable")?a.raw.toc.enable:a.raw.enableToc||!1,maxDepth:a.raw.toc&&a.raw.toc.hasOwnProperty("maxDepth")?a.raw.toc.maxDepth:a.raw.tocMaxDepth||4,headings:[]})},seo:{resolve:a=>a.raw.seo||null}},FooterConfig:{links:{resolve:a=>filterSerachItems(a.links)},columns:{resolve:(a,{ignoreRBAC:b})=>{const c="development"===process.env.NODE_ENV||b;return a.columns?a.columns.filter(a=>c||!a.permission||a.permission===RBAC.GUEST_PERMISSION):[]}}},FooterColumn:{permission:{resolve:a=>a.permission||c},group:{resolve:a=>a.group},items:{resolve:(a,{ignoreRBAC:b})=>filterSerachItems(a.items).filter(a=>{const d=getPageInfo(a.page),e=a.page&&d?d.permission:void 0,f=a.permission||e||c,g="development"===process.env.NODE_ENV||b;return g||f===RBAC.GUEST_PERMISSION})}},Sidebar:{context:{resolve:(b,c,e)=>{if(!b.context)return"";const f=JSON.parse(b.context),g=copyReferencedFiles(f,{context:e,...a},d,d);return JSON.stringify(g)}},permission:{resolve:a=>a.permission||c},pagesIds:{resolve:b=>{const d=expandItems(Array.isArray(b)?b:b.pages,a.reporter,c);return extractSidebarIds(d)}},items:{resolve:(b,{ignoreRBAC:d})=>{const e=expandItems(Array.isArray(b)?b:b.pages,a.reporter,c),f="development"===process.env.NODE_ENV||d;return e.map(a=>removePrivateSidebarItems(a,f)).filter(a=>!!a)}}},NavItem:{redocPrevLink:{resolve:a=>{if(a.page){const b=getPageInfo(a.page);return b&&b.redocPrevLink||null}if(a.redocFakePage&&a.parentPageId){const b=getPageInfo(a.parentPageId);return b&&b.redocPrevLink||null}}},redocPrevLabel:{resolve:a=>{if(a.page){const b=getPageInfo(a.page);return b&&b.redocPrevLabel||null}if(a.redocFakePage&&a.parentPageId){const b=getPageInfo(a.parentPageId);return b&&b.redocPrevLabel||null}}},redocNextLink:{resolve:a=>{if(a.page){const b=getPageInfo(a.page);return b&&b.redocNextLink||null}if(a.redocFakePage&&a.parentPageId){const b=getPageInfo(a.parentPageId);return b&&b.redocNextLink||null}}},redocNextLabel:{resolve:a=>{if(a.page){const b=getPageInfo(a.page);return b&&b.redocNextLabel||null}if(a.redocFakePage&&a.parentPageId){const b=getPageInfo(a.parentPageId);return b&&b.redocNextLabel||null}}},pageId:{resolve:a=>a.page||a.parentPageId},activateWithSidebar:{resolve:a=>a.activateWithSidebar},label:{resolve:a=>{if(a.label)return a.label;if(a.group)return a.group;if(a.page){const b=getPageInfo(a.page);return b&&b.label||`<${a.page}>`}return a.separator?"string"==typeof a.separator?a.separator:"":""}},link:{resolve:a=>{if(a.link)return a.link;if(a.href)return a.href;if(a.page){const b=getPageInfo(a.page);return b&&b.link||null}}},icon:{resolve:(c,e,f)=>{if(c.icon)return fs.existsSync(path.resolve(b.configPath,c.icon))?copyFile(c.icon,{context:f,...a},d,d):c.icon}},httpVerb:{resolve:a=>{if(a.httpVerb)return a.httpVerb;if(a.page){const b=getPageInfo(a.page);return b&&b.httpVerb||null}}},permission:{resolve:a=>a.permission?a.permission:getPageInfo(a.page)?getPageInfo(a.page).permission:c},type:{resolve:a=>a.href?"href":a.page?"page":a.search?"search":a.group?"group":a.separator?"separator":a.separatorLine?"separatorLine":a.logout?"logout":null},items:{resolve:b=>expandItems(b.pages,a.reporter,c)}}})};function extractSidebarIds(a){function b(a){if(Array.isArray(a)){for(let c of a)b(c);return}a&&"object"==typeof a&&a.pages&&b(a.pages),a&&"object"==typeof a&&(a.page||a.parentPageId)&&c.push(a.page||a.parentPageId)}const c=[];return b(a),c}function filterSerachItems(a=[]){return a.filter(a=>!a.search||(console.warn(chalk.yellow("Search item it not allowed in footer. Skip")),!1))}function expandItems(a=[],b,c){if(!a)return[];const d=[];for(const e of a)if(e.page&&(e.page.endsWith("/*")||e.page.endsWith(YAML_PAGE_EXTENSION)))d.push(...getExpandedPagesIds(e,b,c));else if(Array.isArray(e.pages))d.push({...e,pages:expandItems(e.pages,b,c)});else if(e.page){const[a]=e.page.split("/*"),f=getPageInfo(a.replace(/^.\//,""));if(!f){b.panicOnBuild(`Could not find page: ${e.page}.`);continue}const g=e.permission||f.permission||c;d.push({...e,permission:g})}else d.push({...e,permission:e.permission||c});return d}function removePrivateSidebarItems(a,b){if(!a)return null;if("development"===process.env.NODE_ENV)return a;if(b)return a;if(a.permission&&a.permission!==RBAC.GUEST_PERMISSION)return null;const c=resolveSidebarItemPermission({...a,permission:a.permission||RBAC.GUEST_PERMISSION});return c.items=(c.pages||[]).filter(a=>!a.permission||a.permission===RBAC.GUEST_PERMISSION),filterSidebarItems(c),c.group&&0===c.items.length?void 0:c}function resolveSidebarItemPermission(a){return a.items=a.pages?a.pages.map(resolveSidebarItemPermission):void 0,dfsSidebar(a),a}function dfsSidebar(a){for(const b of a.items||[])dfsSidebar(b);a.permission=a.permission||RBAC.GUEST_PERMISSION}function filterSidebarItems(a){a.items||(a.items=[]);for(let b=0;b<(a.items?a.items.length:[]);b++){if(filterSidebarItems(a.items[b]),a.items[b].permission&&a.items[b].permission!==RBAC.GUEST_PERMISSION){a.items[b]=void 0;continue}if(a.items[b].group&&0===a.items[b].items.filter(a=>void 0!==a&&"separator"!==a.type).length){a.items[b]=void 0;continue}}a.items=a.items.filter(a=>a!==void 0),a.pages=a.items}function getExpandedPagesIds(a,b,c){const{page:d}=a,[e]=d.split("/*"),f=e.replace(/^.\//,""),g=getPageInfo(f),h=d.match(/\/\*$/);if(!g&&!h)return b.panicOnBuild(`Page "${d}" is not found. Verify path in "sidebars.yaml"`),[];let i=[];if(!g&&h){for(let{pageId:b,permission:d}of getAllPagesInfo())b&&b.startsWith(e)&&i.push({page:b,permission:d||a.permission||c});i=i.sort((c,a)=>c.page.localeCompare(a.page,{numeric:!0,sensitivity:"base"})).filter(({page:a})=>{const[b,c]=a.split("#");return!(isYamlBasedPage(b)&&c)}),i=groupPagesByFolder(i,e)}else if(g.redocMenuItems&&g.redocMenuItems.length){const b=g.apiVersions.map(a=>{const b=a.isDefault?"":"@"+a.id;return getPageInfo(f+b)});for(const d of b){const b=d.redocMenuItems;h?(d.redocInfoPageId&&i.push({label:d.label,page:d.redocInfoPageId,link:d.link,permission:a.permission||d.permission||c,apiVersionId:d.apiVersionId,isDefaultApiVersion:d.isDefaultApiVersion}),i.push(...b)):i.push({group:d.label,page:d.redocInfoPageId,pages:b,permission:a.permission||d.permission||c,apiVersionId:d.apiVersionId,isDefaultApiVersion:d.isDefaultApiVersion})}}else h||i.push({page:d,permission:a.permission||g.permission||c});return i}function groupPagesByFolder(a,b){const c={pages:[]},d={};for(let e of a){const{page:a,permission:f}=e,g=a.substring(b.length+1),h=g.split("/");let i=c,j="";for(const a of h.slice(0,-1))j+="/"+a,d[j]?i=d[j]:(d[j]={pages:[],group:a},i.pages.push(d[j]),i=d[j]);i.pages.push({page:a,permission:f})}return c.pages}