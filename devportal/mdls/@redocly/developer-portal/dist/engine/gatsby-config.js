const path=require("path"),fs=require("fs"),{parseYaml}=require("@redocly/openapi-core"),_=require("lodash"),replaceEnv=require("./utils/utils").replaceEnv,verifyAndGetLicenseKey=require("./check"),isRelativeUrl=require("is-relative-url"),{getDefaultPermission}=require("./plugins/gatsby-source-redocly-filesystem/rbac"),{staticCopyFile}=require("./plugins/gatsby-source-redocly-filesystem/utils"),reporter=require("../cli/reporter");require("./plugins/gatsby-source-redocly-filesystem/webpack/hotfix-webpack-monkey-patch.js"),require("./plugins/gatsby-source-redocly-filesystem/webpack/hotfix-webpack-crypto-monkey-patch");function findContentFolder(){return process.env.REDOCLY_TEST_CONTENT_DIR?path.resolve(__dirname,"..",process.env.REDOCLY_TEST_CONTENT_DIR):fs.existsSync(`${__dirname}/../../../../siteConfig.yaml`)?path.resolve(`${__dirname}/../../../../`):fs.existsSync(`${__dirname}/../../../../../siteConfig.yaml`)?path.resolve(`${__dirname}/../../../../../`):fs.existsSync("siteConfig.yaml")?path.resolve("."):fs.existsSync("/site/siteConfig.yaml")?path.resolve("/site"):fs.existsSync("/site/src/siteConfig.yaml")?path.resolve("/site/src"):fs.existsSync(`${__dirname}/../site/siteConfig.yaml`)?path.resolve(`${__dirname}/../site/`):fs.existsSync(`${__dirname}/../../site/siteConfig.yaml`)?path.resolve(`${__dirname}/../../site/`):void 0}function getPublicFolder(){return path.resolve(__dirname,"public")}function getSEOdata(a,b){const c=a&&a.seo||{};return{...{title:"ReDoc.ly Portal",description:"",keywords:"",image:"",contentDir:b},...c}}function readConfig(a){try{const b=replaceEnv(fs.readFileSync(path.resolve(a,"siteConfig.yaml"),"utf8"));let c=parseYaml(b);if(c.meta&&(c.seo={...c.meta,...c.seo},console.warn("[warn] \"meta\" is deprecated in siteConfig.yaml, please rename it to \"seo\"")),c.specs&&(c.oasDefinitions=c.specs),c.oasDefinitions&&c.oasDefinitions.$ref){const b=path.resolve(a,c.oasDefinitions.$ref);try{const a=fs.readFileSync(b,"utf-8");c.oasDefinitions=parseYaml(a);for(const a of Object.keys(c.oasDefinitions))isRelativeUrl(c.oasDefinitions[a])&&(c.oasDefinitions[a]=path.resolve(path.dirname(b),c.oasDefinitions[a]))}catch(a){console.warn("Failed to resolve $ref in siteConfig.yaml -> oasDefinitions: "+a.message)}}return c.footer&&c.footer.columns&&c.footer.columns.some(a=>a.label)&&console.warn(`'label' in footer columns is deprecated. Use 'group' instead`),c.footer&&c.footer.links&&console.warn("footer links are deprecated"),c.defaultRbacPermission=getDefaultPermission(a),!process.env.REDOCLY_DEPLOYMENT_URL||c.seo&&c.seo.siteUrl||(c.seo=c.seo||{},c.seo.siteUrl=process.env.REDOCLY_DEPLOYMENT_URL),c.copyCodeSnippet=c.copyCodeSnippet||{},c}catch(a){"ENOENT"===a.code?(console.log("[error] siteConfig.yaml not found"),process.exit(1)):console.log("[error] failed to load siteConfig.yaml",a)}return{}}const contentDir=findContentFolder(),nodeEnv=process.env.NODE_ENV||`development`,configEnv=process.env.REDOCLY_ACTIVE_ENV||nodeEnv,conf=require("dotenv").config({path:path.join(contentDir,`.env.${configEnv}`)}),dotEnvVars=Object.keys(conf.parsed||{}),config=readConfig(contentDir),disableImagesOptimization=config.disableImagesOptimization||!!process.env.REDOCLY_DISABLE_IMAGES_OPTIMIZATION,allowedClientEnvVars=(Array.isArray(config.envVariablesAllowedClientSide)?config.envVariablesAllowedClientSide:[]).concat(dotEnvVars);"build"===process.env.gatsby_executing_command&&verifyAndGetLicenseKey(process.env.REDOCLY_LICENSE_KEY||config.licenseKey);const analytics=config.analytics||{};analytics.googleOptimize&&analytics.ga&&console.warn("[warn] both \"ga\" and \"googleOptimize\" configuration provided, use only one at a time"),analytics.googleOptimize&&analytics.gtm&&console.warn("[warn] both \"gtm\" and \"googleOptimize\" configuration provided, use only one at a time"),config.ga&&(analytics.ga=config.ga,console.warn("[warn] \"ga\" is deprecated in siteConfig.yaml, use analytics.ga instead")),config.googleTagManager&&(analytics.gtm=config.googleTagManager,console.warn("[warn] \"googleTagManager\" is deprecated in siteConfig.yaml, use analytics.gtm instead")),config.heapAnalytics&&(analytics.heap=config.heapAnalytics,console.warn("[warn] \"heapAnalytics\" is deprecated in siteConfig.yaml, use analytics.heap instead")),config.segmentAnalytics&&(analytics.segment=config.segmentAnalytics,console.warn("[warn] \"segmentAnalytics\" is deprecated in siteConfig.yaml, use analytics.segment instead"));const pathPrefix=process.env.REDOCLY_PREFIX_PATHS||"/",gatsbyPluginSitemap={resolve:path.resolve(__dirname,"plugins/gatsby-plugin-sitemap"),options:{output:"/",query:`
       {
          allContentItem(filter: { data: { excludeFromSearch: { ne: true } } }) {
            nodes {
              link
              data {
                sitemap {
                  changefreq
                  priority
                  lastmod
                }
              }
            }
          }
        }
    `,resolveSiteUrl:()=>config.seo.siteUrl,resolvePages:({allContentItem:{nodes:a}})=>a.map(({link:a,data:{sitemap:b={}}})=>({path:a,...b})),resolvePagePath:a=>a.path,serialize:({path:a,priority:b,...c})=>({url:a,priority:"number"==typeof b?b||0:void 0,...c})}},gatsbyPluginCanonicalUrls={resolve:path.resolve(__dirname,"plugins/gatsby-plugin-canonical-urls"),options:{siteUrl:config.seo.siteUrl,stripHash:!0}};module.exports={assetPrefix:process.env.REDOCLY_PREFIX_ASSETS||"",flags:{FAST_DEV:!1,DEV_SSR:!1,LAZY_IMAGES:!0,PRESERVE_WEBPACK_CACHE:!0,PRESERVE_FILE_DOWNLOAD_CACHE:!0,PARALLEL_SOURCING:!1},pathPrefix,siteMetadata:getSEOdata(config,contentDir),plugins:_.compact([`gatsby-plugin-react-helmet`,`gatsby-plugin-layout`,{resolve:"gatsby-source-filesystem",options:{name:"content",path:contentDir,ignore:[/@redocly\/developer-portal\/dist\/engine\//,/\/.git\//,/\/.github\//,/\/node_modules\//,/(^|\/)\.#/]}},{resolve:"gatsby-source-redocly-filesystem",options:{configPath:contentDir,envVariablesAllowedClientSide:allowedClientEnvVars,getSiteConfig:()=>readConfig(contentDir),postBodyScripts:(config.postBodyScripts||[]).map(a=>staticCopyFile(a,{reporter,pathPrefix},contentDir,contentDir)),publicDir:getPublicFolder()}},{resolve:"gatsby-redocly-siteconfig-to-build",options:{configPath:contentDir,publicDir:getPublicFolder()}},{resolve:"gatsby-relative-paths"},disableImagesOptimization?null:"@redocly/gatsby-plugin-sharp",{resolve:"gatsby-transformer-remark",options:{plugins:_.compact([{resolve:path.resolve(__dirname,"plugins/gatsby-redocly-reusable-markdown-snippets"),options:{configPath:contentDir}},{resolve:path.resolve(__dirname,"plugins/gatsby-redocly-code-metadata")},{resolve:path.resolve(__dirname,"plugins/gatsby-remark-preprocess-redocly")},{resolve:path.resolve(__dirname,"plugins/gatsby-redocly-mermaid")},disableImagesOptimization?null:{resolve:"@redocly/gatsby-remark-images",options:{maxWidth:910,linkImagesToOriginal:!1}},"gatsby-remark-image-attributes",{resolve:path.join(__dirname,"plugins/gatsby-remark-autolink-headers"),options:{offsetY:{element:"nav"}}},{resolve:"gatsby-remark-prismjs"},{resolve:path.resolve(__dirname,"plugins/gatsby-redocly-remark-code-buttons"),options:config.copyCodeSnippet},{resolve:path.resolve(__dirname,"plugins/gatsby-remark-enhancer-redocly"),options:{envVariablesAllowedClientSide:allowedClientEnvVars}},{resolve:"gatsby-remark-copy-linked-files",options:{ignoreFileExtensions:disableImagesOptimization?[]:void 0}}])}},process.env.REDOCLY_RELATIVE_PATHS?void 0:{resolve:"gatsby-plugin-catch-links",options:{excludePattern:/(idp-login)/}},"gatsby-plugin-nprogress","gatsby-plugin-styled-components",process.env.REDOCLY_PREFIX_ASSETS?void 0:{resolve:`gatsby-plugin-manifest`,options:{icon:path.resolve(contentDir,"favicon.png"),name:config.seo&&config.seo.title||"API Portal"}},{resolve:"gatsby-redocly-search",options:{publicDir:getPublicFolder()}},analytics.ga&&analytics.ga.trackingId&&{resolve:`gatsby-plugin-google-analytics`,options:analytics.ga}||void 0,analytics.gtm&&analytics.gtm.id&&{resolve:`gatsby-plugin-google-tagmanager`,options:analytics.gtm}||void 0,analytics.heap&&analytics.heap.appId&&{resolve:`gatsby-plugin-heap`,options:analytics.heap}||void 0,analytics.segment&&analytics.segment.prodKey&&{resolve:`gatsby-plugin-segment-js`,options:analytics.segment}||void 0,analytics.fullstory&&analytics.fullstory.fs_org&&{resolve:`gatsby-plugin-fullstory`,options:analytics.fullstory}||void 0,analytics.gtag&&{resolve:`gatsby-plugin-google-gtag`,options:analytics.gtag}||void 0,analytics.amplitude&&analytics.amplitude.apiKey&&{resolve:`gatsby-plugin-amplitude-analytics`,options:analytics.amplitude}||void 0,analytics.googleOptimize&&{resolve:"gatsby-plugin-google-marketing-platform",options:{includeInDevelopment:!1,...analytics.googleOptimize}}||void 0,config.seo&&config.seo.siteUrl?gatsbyPluginCanonicalUrls:void 0,config.seo&&config.seo.siteUrl?gatsbyPluginSitemap:void 0,"gatsby-plugin-redirect"])};