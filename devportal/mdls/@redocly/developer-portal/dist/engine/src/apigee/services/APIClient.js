import{getUserClaims}from"../../ui/auth/utils";import{APIGEE_VERSION}from"./apigee-api-types";const DEVELOPER_DOES_NOT_EXIST_CODE="developer.service.DeveloperDoesNotExist";function normalizeEmail(a){return a.replace(/\+/g,"%2B")}export class APIClient{constructor({apiUrl:a="",accessToken:b=null,organizationName:c="",email:d="",version:e="apigeex"}){this.accessToken=null,this.apiUrl=a,this.accessToken=b,this.organizationName=c,this.email=d,this.organizationUrl=`${this.apiUrl}/organizations/${this.organizationName}`,this.developerUrl=`${this.organizationUrl}/developers/${normalizeEmail(this.email)}`,this.version=e}setAuthHeader(a){return a=a||{},a.headers={...a.headers,"jwt-token":this.accessToken},a}getErrorMessage(a){if(!a)return"Fetch error";try{const b=JSON.parse(a);return b.code===DEVELOPER_DOES_NOT_EXIST_CODE?b.code:"type.googleapis.com/google.rpc.PreconditionFailure"===b.error.details[0]?.["@type"]&&b.error.details[0]?.violations[0]?.type===DEVELOPER_DOES_NOT_EXIST_CODE?DEVELOPER_DOES_NOT_EXIST_CODE:b?.message||b.error.message}catch{return a}}async fetchData(a,b){const c=this.setAuthHeader(b),d=await fetch(a,c);if(!d.ok){const c=await d.text(),e=this.getErrorMessage(c);if(e===DEVELOPER_DOES_NOT_EXIST_CODE){const c=getUserClaims(),d=c?.given_name||"Unknown",e=c?.family_name||"User",f=`${d.toLowerCase()}_${e.toLowerCase()}`;return await this.createDeveloper(this.email,d,e,f),void(await this.fetchData(a,b))}throw new Error(e)}return d.headers.get("x-redocly-apigee-version")===APIGEE_VERSION.x&&(this.version=APIGEE_VERSION.x),d.json()}async multipleFetchData(a,b){const c=this.setAuthHeader(b),d=a.reduce(async(a,b)=>{await a;const d=await fetch(b,c);if(!d.ok){const a=await d.text();throw new Error(this.getErrorMessage(a))}return d.json()},Promise.resolve());return d}getDeveloperApps(){const a=`${this.developerUrl}/apps?expand=true`;return this.fetchData(a)}getApiProducts(){const a=`${this.organizationUrl}/apiproducts?expand=true`;return this.fetchData(a)}getDeveloperApp(a){const b=`${this.developerUrl}/apps/${a}${this.version===APIGEE_VERSION.edge?"?expand=true":""}`;return this.fetchData(b)}getDeveloper(){const a=`${this.developerUrl}`;return this.fetchData(a)}createDeveloper(a,b,c,d){const e=`${this.organizationUrl}/developers`;return this.fetchData(e,{headers:{"Content-type":"application/json"},body:JSON.stringify({email:a,firstName:b,lastName:c,userName:d}),method:"POST"})}createDeveloperApp(a,b){const c=`${this.developerUrl}/apps`;return this.fetchData(c,{headers:{"Content-type":"application/json"},body:JSON.stringify({name:a,apiProducts:b}),method:"POST"})}renameDeveloperApp(a,b){const c=`${this.developerUrl}/apps/${a}`;return this.fetchData(c,{headers:{"Content-type":"application/json"},body:JSON.stringify({attributes:[{name:"DisplayName",value:b}]}),method:"PUT"})}deleteDeveloperApp(a){const b=`${this.developerUrl}/apps/${a}`;return this.fetchData(b,{headers:{"Content-type":"application/json"},method:"DELETE"})}createDeveloperAppKey(a,b,c){const d=`${this.developerUrl}/apps/${a}`;return this.fetchData(d,{headers:{"Content-type":"application/json"},method:"PUT",body:JSON.stringify({apiProducts:b,attributes:c})})}deleteDeveloperAppKey(a,b){const c=`${this.developerUrl}/apps/${a}/keys/${b}`;return this.fetchData(c,{headers:{"Content-type":"application/octet-stream"},method:"DELETE"})}updateDeveloperAppKey(a,b,c,d){const e=`${this.developerUrl}/apps/${a}/keys/${b}`;return this.fetchData(e,{headers:{"Content-type":"application/json"},method:"POST",body:JSON.stringify({apiProducts:c,attributes:d})})}deleteDeveloperAppKeyProduct(a,b,c){const d=c.map(c=>`${this.developerUrl}/apps/${a}/keys/${b}/apiproducts/${c}`);return this.multipleFetchData(d,{headers:{"Content-type":"application/json"},method:"DELETE"})}}