import*as React from"react";import{graphql,useStaticQuery}from"gatsby";import{anypointAuthorizeEndpoint,getRedoclyAnypointUri}from"./config";export const AnypointAuthContext=React.createContext(void 0);function getRefreshToken(a){if("undefined"!=typeof localStorage)try{const b=JSON.parse(localStorage.getItem("anypoint_refresh_token")||"{}");return b.scope===a?Date.now()>b.iat+5184000000?void 0:b.value:void 0}catch(a){}}function saveRefreshToken(a,b){localStorage.setItem("anypoint_refresh_token",JSON.stringify({scope:b,value:a,iat:Date.now()}))}export function AnypointAuth(a){const[b,c]=React.useState(getRefreshToken(a.scope)),{config:{redoclyOrgId:d,mulesoftAnypoint:e={appClientId:"",orgId:""}}}=useStaticQuery(graphql`
    {
      config: siteConfig {
        redoclyOrgId
        mulesoftAnypoint {
          appClientId
          orgId
        }
      }
    }
  `);d||console.warn("You must set \"redoclyOrgId\" in \"siteConfig.yaml\" to use AnypointAuth"),e.appClientId||console.warn("You must configure \"mulesoftAnypoint.appClientId\" in \"siteConfig.yaml\" to use AnypointAuth"),e.orgId||console.warn("You must configure \"mulesoftAnypoint.orgId\" in \"siteConfig.yaml\" to use AnypointAuth");const f=React.useCallback(()=>{const b=window.open(`${anypointAuthorizeEndpoint}?response_type=code&client_id=${e.appClientId}&redirect_uri=${encodeURIComponent(getRedoclyAnypointUri(d))}&scope=${encodeURIComponent(a.scope)}`,"_blank");window.addEventListener("message",d=>{if(d&&"redocly_anypoint_token"===d.data.message){const e=d.data.result;e&&e.refresh_token&&(saveRefreshToken(e.refresh_token,a.scope),c(e.refresh_token)),b&&(clearInterval(f),b.close())}});let f=setInterval(()=>{try{b&&b.postMessage({message:"redocly_get_token"},"*")}catch(a){if(b&&b.closed)return void clearInterval(f)}},300)},[a.scope,d,e.appClientId]),[g,h]=React.useState(),i=React.useCallback(async(...e)=>{let f=g;if(!f){const e=await fetch(`${getRedoclyAnypointUri(d)}&refresh_token=${b}`),g=await e.json();g&&(setTimeout(()=>{saveRefreshToken(g.refresh_token,a.scope),c(g.refresh_token),h(g.access_token),setTimeout(()=>{h(void 0)},3000000)}),f=g.access_token)}const i=await fetch(e[0],{...e[1],headers:{Authorization:`bearer ${f}`,...(e[1]&&e[1].headers)}});return i.ok||401!==i.status||(localStorage.removeItem("anypoint_refresh_token"),c("")),i},[g,b,a.scope]);return b?React.createElement(AnypointAuthContext.Provider,{value:{authorized:!0,authorizedFetch:i,accessToken:g,...e}},a.children):React.createElement(AnypointAuthContext.Provider,{value:{authorized:!1,redirectToAuthEndpoint:f,...e}},a.children)}