"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TryItPanel=exports.Console=void 0;var tslib_1=require("tslib"),React=(0,tslib_1.__importStar)(require("react")),informed_1=require("informed"),mobx_react_1=require("mobx-react"),utils_1=require("../../utils"),styled_components_1=require("./styled.components"),ServerDropdown_1=require("./ServerDropdown"),OperationParameters_1=require("./OperationParameters"),ActionPanel_1=require("./ActionPanel"),ResponsePanel_1=require("./ResponsePanel"),RequestBody_1=require("./RequestBody"),ConsoleBadges_1=require("./ConsoleBadges"),AuthPanel_1=require("./AuthPanel"),services_1=require("../../services"),swagger_client_1=(0,tslib_1.__importDefault)(require("swagger-client")),redoc_lib_1=require("../../redoc-lib"),helper_1=require("../../redoc-lib/src/components/helper"),Labels_1=require("../../redoc-lib/src/services/Labels"),styled_components_2=(0,tslib_1.__importDefault)(require("../../redoc-lib/src/styled-components")),Panel_1=require("../Panel"),OAuth2_1=require("../../services/OAuth2"),PanelBody_1=require("../Panel/PanelBody"),utils_2=require("./utils"),helper_2=require("../common/FileUpload/helper");function normalizeUrlProtocol(e){return e.startsWith("//")?"https:"+e:e}var flexColumn={flex:1,display:"flex",flexDirection:"column"},Console=function(e){function t(t){var r=e.call(this,t)||this;return Object.defineProperty(r,"formApi",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(r,"setFormApi",{enumerable:!0,configurable:!0,writable:!0,value:function(e,t){void 0===t&&(t=e.getState());var n=t.values,a=(0,tslib_1.__rest)(t,["values"]);r.formApi=e,setTimeout((function(){var e=(0,tslib_1.__assign)((0,tslib_1.__assign)({},a),{values:(0,tslib_1.__assign)((0,tslib_1.__assign)({},n),{query:(0,utils_2.unescapeQueryParams)(n.query||{})})});r.setState({form:e})}),0)}}),Object.defineProperty(r,"handleChange",{enumerable:!0,configurable:!0,writable:!0,value:function(e){var t=e.values,n=(0,tslib_1.__rest)(e,["values"]),a=(0,tslib_1.__assign)((0,tslib_1.__assign)({},n),{values:(0,tslib_1.__assign)((0,tslib_1.__assign)({},t),{query:(0,utils_2.unescapeQueryParams)(t.query||{})})});r.setState({form:a}),(0,utils_2.updateStorage)(a)}}),Object.defineProperty(r,"handleTabChange",{enumerable:!0,configurable:!0,writable:!0,value:function(e){r.setState({activeTab:e})}}),Object.defineProperty(r,"handleServerChange",{enumerable:!0,configurable:!0,writable:!0,value:function(e){r.setState({server:e}),r.props.operation.setActiveServer(e)}}),Object.defineProperty(r,"handleExecute",{enumerable:!0,configurable:!0,writable:!0,value:function(){return(0,tslib_1.__awaiter)(r,void 0,void 0,(function(){var e,t,r,n,a,s,o,i,l,c,u,d,p,_,h,m,b,v,y,g,f,P,R,q,S,C,w,E,I,x,A,T,O,k,B,j,F,H,D=this;return(0,tslib_1.__generator)(this,(function(U){switch(U.label){case 0:if(e=this.props,t=e.store,r=e.operation,n=e.onResponse,a=this.state.form,s=a.values,o=a.invalid,this.formApi.submitForm(),o)return this.setState({shaking:!0}),setTimeout((function(){return D.setState({shaking:!1})}),1e3),null===(O=null===(T=null==t?void 0:t.options.events)||void 0===T?void 0:T.tryItSent)||void 0===O||O.call(T,{eventType:services_1.AnalyticsEventType.TryItSent,resource:"Redocly_OperationTryIt",action:"ValidationFailed",operationId:r.operationId,operationPath:r.path,operationHttpVerb:r.httpVerb,operationSummary:r.description}),[2];if(i=this.props.operation.requestBody,l=i&&i.content&&i.content.active&&i.content.active.name||"",c=s.body,/json/.test(l))try{c=JSON.parse(c)}catch(e){console.error(e)}if(this.setState({loading:!0}),u=this.state.resolvedRawSpec,!(d=(0,utils_1.get)(u,["paths",r.path,(r.httpVerb||"").toLowerCase(),"servers"])||(0,utils_1.get)(u,["paths",r.path,"servers"])||(0,utils_1.get)(u,["servers"])))throw console.error("Servers are not specified in your OpenAPI file. You can't use Try It Out console without specifying servers. If you use OpenAPI 2, make sure you configured host and basepath"),new Error("Servers are not specified");p=d.find((function(e){return D.state.server.url.endsWith(e.url.endsWith("/")?e.url.substring(0,e.url.length-1):e.url)})),_=Date.now(),h=!!window.document.documentMode,b=s.auth,s.auth?(v=Object.keys(s.auth)[0],y=(0,utils_1.unescapeFormId)(v),m=(0,tslib_1.__assign)((0,tslib_1.__assign)({},u),{components:(0,tslib_1.__assign)((0,tslib_1.__assign)({},u.components),{securitySchemes:(0,tslib_1.__assign)((0,tslib_1.__assign)({},u.components.securitySchemes),(x={},x[y]=(0,tslib_1.__assign)((0,tslib_1.__assign)({},u.components.securitySchemes[y]),{type:"openIdConnect"===u.components.securitySchemes[y].type?"oauth2":u.components.securitySchemes[y].type}),x))})}),b=(0,tslib_1.__assign)((0,tslib_1.__assign)({},b),((A={})[y]=b[v],A))):m=(0,tslib_1.__assign)({},u),(g=t.options.corsProxyUrl)&&u.servers&&u.servers.length&&(m.servers=u.servers.map((function(e){return(0,tslib_1.__assign)((0,tslib_1.__assign)({},e),{url:g+normalizeUrlProtocol(e.url)})}))),(f=(null===(B=null===(k=null==i?void 0:i.content)||void 0===k?void 0:k.active)||void 0===B?void 0:B.name)||null)&&c&&(0,helper_2.isFileUploadMime)(f)&&(P=Object.values(c),c=P.length>1?P:P[0]),R=function(e,t){return function(r){return D.props.store.options.sendXUserAgentInTryIt&&(r.headers["X-User-Agent"]="Redocly Try it API console"),e?e(r,t):r}},q={userFetch:h&&require("cross-fetch").fetch,server:g?g+normalizeUrlProtocol(p.url):p.url,serverVariables:this.state.server.variables,spec:m,pathName:r.path,method:r.httpVerb,parameters:(0,tslib_1.__assign)((0,tslib_1.__assign)((0,tslib_1.__assign)((0,tslib_1.__assign)({},s.path),s.query),s.header),s.cookie),securities:{authorized:b},requestBody:c,requestContentType:f,responseContentType:(null===(j=s.header)||void 0===j?void 0:j.Accept)||null,requestInterceptor:R(t.options.requestInterceptor,r)},U.label=1;case 1:return U.trys.push([1,5,8,9]),[4,swagger_client_1.default.execute(q)];case 2:return S=U.sent(),(C=null==S?void 0:S.data)instanceof Blob?((0,helper_2.isFileUploadMime)(C.type)&&(S.fileInfo={rawData:C,fileName:(0,utils_2.getFileNameFromHeaders)(S.headers)}),w=S,[4,C.text()]):[3,4];case 3:w.data=U.sent(),U.label=4;case 4:return null==n||n({request:q,response:S}),this.setState({response:S,error:void 0}),[3,9];case 5:return(E=U.sent())&&E.response&&E.response.data instanceof Blob?(I=E.response,[4,E.response.data.text()]):[3,7];case 6:I.data=U.sent(),null==n||n({request:q,response:E.response}),U.label=7;case 7:return this.setState({response:void 0,error:E}),[3,9];case 8:return this.setState({loading:!1,activeTab:1,time:Date.now()-_}),null===(H=null===(F=null==t?void 0:t.options.events)||void 0===F?void 0:F.tryItSent)||void 0===H||H.call(F,{eventType:services_1.AnalyticsEventType.TryItSent,resource:"Redocly_OperationTryIt",action:"Sent",operationId:r.operationId,operationPath:r.path,operationHttpVerb:r.httpVerb,operationSummary:r.description}),[7];case 9:return[2]}}))}))}}),r.state={form:{values:{path:(0,utils_2.getParameters)(t.operation.parameters,"path"),cookie:(0,utils_2.getParameters)(t.operation.parameters,"cookie"),header:(0,utils_2.getParameters)(t.operation.parameters,"header"),query:(0,utils_2.getParameters)(t.operation.parameters,"query")}},shaking:!1,loading:!1,activeTab:0,server:{}},r}return(0,tslib_1.__extends)(t,e),Object.defineProperty(t.prototype,"componentDidMount",{enumerable:!1,configurable:!0,writable:!0,value:function(){return(0,tslib_1.__awaiter)(this,void 0,void 0,(function(){var e,t,r,n;return(0,tslib_1.__generator)(this,(function(a){switch(a.label){case 0:return e=this.props,t=e.store,r=e.operation,[4,t.dereferenceSpecForTryIt(r)];case 1:return n=a.sent(),this.setState({resolvedRawSpec:n}),this.formApi.setValues({}),[2]}}))}))}}),Object.defineProperty(t.prototype,"componentDidUpdate",{enumerable:!1,configurable:!0,writable:!0,value:function(e){e.operation!==this.props.operation&&this.setState({response:void 0,error:void 0,activeTab:0})}}),Object.defineProperty(t.prototype,"render",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=this.props,t=e.operation,r=e.className,n=e.rootElement,a=this.state,s=a.shaking,o=a.activeTab,i=a.form,l=a.response,c=a.loading,u=a.error,d=!(!l&&!u);return React.createElement(ConsoleWrapHook,{shaking:s,className:r,rootElement:n},React.createElement(Panel_1.CodeHeader,null,React.createElement(ConsoleBadges_1.ConsoleBadges,{active:o,hasResponse:d,onChange:this.handleTabChange}),this.props.onClose&&React.createElement(styled_components_1.CloseButton,{onClick:this.props.onClose}," âœ• ")),React.createElement(styled_components_1.ConsoleBody,{hidden:0!==o},this.renderRequest()),React.createElement(styled_components_1.ConsoleBody,{hidden:1!==o},this.renderResponse()),React.createElement(ActionPanel_1.ActionPanel,{hasResponse:d,params:i.values,operation:t,loading:c,execute:this.handleExecute}))}}),Object.defineProperty(t.prototype,"renderRequest",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e,t=this.props,r=t.operation,n=t.store,a=t.properties,s=t.securityDefaults,o=this.state,i=o.form,l=o.resolvedRawSpec,c=o.server,u=i.errors||{},d=u.path||u.cookie||u.header||u.query,p=l&&redoc_lib_1.JsonPointer.get(l,r.pointer),_=i.values&&i.values.auth&&Object.keys(i.values.auth)[0];_&&i.values.auth[_]||(_=void 0),!_||void 0===i.values.auth[_].token&&void 0===i.values.auth[_].client_id&&void 0===i.values.auth[_].client_secret||i.values.auth[_].token&&i.values.auth[_].token.access_token||(_=void 0),_&&null!=i.values.auth[_].username&&(i.values.auth[_].username&&i.values.auth[_].password||(_=void 0));var h=r.parameters||[],m=null===(e=null==n?void 0:n.options.hooks)||void 0===e?void 0:e.ReplaceTryItSecurityPanel;return!l&&React.createElement(React.Fragment,null,"Loading...")||React.createElement(React.Fragment,null,React.createElement(informed_1.Form,{onChange:this.handleChange,getApi:this.setFormApi,style:(0,tslib_1.__assign)((0,tslib_1.__assign)({},flexColumn),{margin:0})},React.createElement(Panel_1.Accordion,{initialActiveIdx:r.security.length&&_?1:0},r.security.length&&React.createElement(TryItPanel,{header:(0,Labels_1.l)("tryItAuth"),"data-cy":"security-trigger",renderChildrenHidden:!0,error:!_&&!!u.auth,success:!!_},m?React.createElement(AuthPanelHook,{field:"auth",validate:AuthPanel_1.requiredValidator},(function(e){return React.createElement(helper_1.RenderHook,{Hook:m,props:{server:c,operation:r,onChange:e,OAuth2:OAuth2_1.OAuth2}})})):React.createElement(AuthPanel_1.AuthPanel,{formApi:this.formApi,form:i,operation:r,activeServer:c.url,authCorsProxyUrl:n.options.authCorsProxyUrl,securityDefaults:s}))||null,r.requestBody&&React.createElement(TryItPanel,{header:(0,Labels_1.l)("tryItBody"),"data-cy":"body-trigger",renderChildrenHidden:!0,error:!!u.body},React.createElement(RequestBody_1.RequestBody,{validate:allowBodyErrors,console:this,body:r.requestBody,id:r.id,resolvedBody:p.requestBody,properties:a}))||null,h.length&&React.createElement(TryItPanel,{header:(0,Labels_1.l)("tryItParameters"),"data-cy":"parameters-trigger",error:d,renderChildrenHidden:!0},React.createElement(OperationParameters_1.OperationParameters,{operation:r,values:i.values,errors:i.errors||{}}))||null)),React.createElement(ServerDropdown_1.ServerChooser,{operation:r,onChange:this.handleServerChange}))}}),Object.defineProperty(t.prototype,"renderResponse",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=this.state,t=e.response,r=e.error,n=e.time;return React.createElement(ResponsePanel_1.ResponsePanel,{response:t,error:r,time:n})}}),t=(0,tslib_1.__decorate)([mobx_react_1.observer],t)}(React.Component);function allowBodyErrors(){}function ConsoleWrapHook(e){var t=e.shaking,r=e.className,n=e.children,a=e.rootElement,s=(0,utils_1.useDimensions)(a)[0];return React.createElement(styled_components_1.ConsoleWrap,{shaking:t,className:r,"data-cy":"console",fullWidth:null==s?void 0:s.width},n)}function AuthPanelHook(e){var t=(0,informed_1.useField)((0,tslib_1.__assign)({},e)),r=t.fieldApi,n=t.render,a=t.userProps,s=r.setValue,o=a.children;return n(React.createElement(React.Fragment,null,o(s)))}function TryItPanel(e){var t=e.header,r=e.error,n=e.success,a=(0,tslib_1.__rest)(e,["header","error","success"]);return React.createElement(StyledTryItPanel,(0,tslib_1.__assign)({},a,{header:function(e){var s=e.toggle,o=e.expanded;return React.createElement(Panel_1.Header,{onClick:s,isExpanded:o,"data-cy":a["data-cy"]},React.createElement(Panel_1.Trigger,null,React.createElement(Panel_1.Title,null,t),React.createElement(redoc_lib_1.ShelfIcon,{direction:o?"down":"right"})),r&&React.createElement(redoc_lib_1.CrossIcon,{size:"14px",color:"#ff908b"})||null,n&&React.createElement(redoc_lib_1.LockIcon,{size:"14px",color:"#56ff26"})||null)}}))}exports.Console=Console,exports.TryItPanel=TryItPanel;var templateObject_1,StyledTryItPanel=(0,styled_components_2.default)(Panel_1.Panel)(templateObject_1||(templateObject_1=(0,tslib_1.__makeTemplateObject)(["\n  "," {\n    color: white;\n    border: 1px solid ",";\n    padding: 10px;\n  }\n\n  "," path {\n    fill: white;\n  }\n\n  "," {\n    padding: 15px 10px;\n    background-color: #3e4c59;\n    border: 1px solid ",";\n    border-top: 0;\n  }\n"],["\n  "," {\n    color: white;\n    border: 1px solid ",";\n    padding: 10px;\n  }\n\n  "," path {\n    fill: white;\n  }\n\n  "," {\n    padding: 15px 10px;\n    background-color: #3e4c59;\n    border: 1px solid ",";\n    border-top: 0;\n  }\n"])),Panel_1.Header,(function(e){return e.error?"#ff908b":"#89949f"}),redoc_lib_1.ShelfIcon,PanelBody_1.PanelBody,(function(e){return e.error?"#ff908b":"#89949f"}));
//# sourceMappingURL=Console.js.map