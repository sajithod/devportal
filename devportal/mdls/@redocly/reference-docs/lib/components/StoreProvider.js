"use strict";var _a;Object.defineProperty(exports,"__esModule",{value:!0}),exports.loadSpecs=exports.ProStoreProvider=exports.Consumer=exports.Provider=void 0;var tslib_1=require("tslib"),React=(0,tslib_1.__importStar)(require("react")),redoc_lib_1=require("../redoc-lib"),ProStore_1=require("../services/ProStore"),fast_deep_equal_1=(0,tslib_1.__importDefault)(require("fast-deep-equal")),services_1=require("../services");exports.Provider=(_a=React.createContext(void 0)).Provider,exports.Consumer=_a.Consumer;var ProStoreProvider=function(e){var t=e.definitions,r=e.options,n=e.definitionUrl,i=e.definition,o=e.activeItemId,s=e.activeSampleLanguage,a=e.activeDeepLink,c=e.children,u=React.useState()[1],l=React.useState(!0),d=l[0],f=l[1],p=React.useState(null),v=p[0],_=p[1];React.useEffect((function(){!function(){(0,tslib_1.__awaiter)(this,void 0,void 0,(function(){var e,o,s;return(0,tslib_1.__generator)(this,(function(a){switch(a.label){case 0:f(!0),a.label=1;case 1:return a.trys.push([1,6,,7]),e=_,t?[4,loadMany(t)]:[3,3];case 2:return o=a.sent(),[3,5];case 3:return[4,loadSingle(i,n,r)];case 4:o=a.sent(),a.label=5;case 5:return e.apply(void 0,[o]),[3,7];case 6:return s=a.sent(),u((function(){throw s})),[3,7];case 7:return[2]}}))}))}()}),[t,i,n,r]);var h=React.useMemo((function(){var e,t,i;if(v){var o=new ProStore_1.ProStore(v,n,r);return(null===(e=o.options.hooks)||void 0===e?void 0:e.onInit)&&(null===(i=null===(t=o.options.hooks)||void 0===t?void 0:t.onInit)||void 0===i||i.call(t,{store:o})),o}}),useDeepCompareMemoize([v,r]));return React.useEffect((function(){if(h)return f(!1),function(){return h.dispose()}}),[h]),React.useEffect((function(){var e;if(h&&o){var t=(null==o?void 0:o.split(h.options.deepLinkPrefix)[0])||(null===(e=h.menu.flatItems[h.menu.activeItemIdx])||void 0===e?void 0:e.id),r=h.menu.flatItems.find((function(e){return e.id===t})),n=a?t+h.options.deepLinkPrefix+a:void 0;n&&h.menu.history instanceof services_1.FakeHistoryService&&h.menu.history.replaceForField(n),h.menu.activateAndScroll(r,!0,!1,n)}}),[o,a,h]),React.useEffect((function(){h&&s&&h.setActiveSampleLanguage(s)}),[s,h]),c({loading:d,store:h})};function fixSpec(e){for(var t=e.components&&e.components.securitySchemes||{},r=0,n=Object.keys(t);r<n.length;r++){var i=t[n[r]];i["x-type"]&&(i.type=i["x-type"]),i["x-scheme"]&&(i.scheme=i["x-scheme"])}}function loadMany(e){return(0,tslib_1.__awaiter)(this,void 0,void 0,(function(){return(0,tslib_1.__generator)(this,(function(t){switch(t.label){case 0:return[4,loadSpecs(e||{})];case 1:return t.sent(),[2,e]}}))}))}function loadSingle(e,t,r){return(0,tslib_1.__awaiter)(this,void 0,void 0,(function(){var n,i,o,s,a;return(0,tslib_1.__generator)(this,(function(c){switch(c.label){case 0:if(!(null==r?void 0:r.skipBundleAndConvert))return[3,1];if(!e)throw new Error('spec must be specified when using "skipBundleAndConvert"');return n=e,[3,3];case 1:return[4,(0,redoc_lib_1.loadAndBundleDefinition)(e||t)];case 2:n=c.sent(),c.label=3;case 3:if(!(i=null==r?void 0:r.unstable_externalDescription))return[3,8];c.label=4;case 4:return c.trys.push([4,7,,8]),[4,fetch(i)];case 5:return o=c.sent(),s=n.info,[4,o.text()];case 6:return s.description=c.sent(),[3,8];case 7:return a=c.sent(),console.warn("Failed to load external description from "+i+": "+a.message),[3,8];case 8:try{fixSpec(n)}catch(e){}return[2,n]}}))}))}function loadAndBundleSpecOrMd(e,t){return e.endsWith(".md")?(0,redoc_lib_1.loadAndBundleDefinition)({openapi:"3.0.0",info:{title:t||"",version:"1.0",description:{$ref:e}},paths:{}}):(0,redoc_lib_1.loadAndBundleDefinition)(e)}function loadSpecs(e){var t=e.versions;return(0,tslib_1.__awaiter)(this,void 0,void 0,(function(){var e,r,n,i;return(0,tslib_1.__generator)(this,(function(o){switch(o.label){case 0:if(!Array.isArray(t))return[3,4];e=0,r=t,o.label=1;case 1:return e<r.length?(n=r[e]).url?(i=n,[4,loadAndBundleSpecOrMd(n.url)]):[3,3]:[3,4];case 2:i.spec=o.sent(),o.label=3;case 3:return e++,[3,1];case 4:return[2]}}))}))}function useDeepCompareMemoize(e){var t=React.useRef(),r=React.useRef(0);return(0,fast_deep_equal_1.default)(e,t.current)||(t.current=e,r.current+=1),[r.current]}exports.ProStoreProvider=ProStoreProvider,exports.loadSpecs=loadSpecs;
//# sourceMappingURL=StoreProvider.js.map