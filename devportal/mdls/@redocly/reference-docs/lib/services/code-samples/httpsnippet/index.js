"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.HTTPSnippet=void 0;var tslib_1=require("tslib"),qs=(0,tslib_1.__importStar)(require("querystring")),url=(0,tslib_1.__importStar)(require("url")),reducer_1=(0,tslib_1.__importDefault)(require("./helpers/reducer")),targets_1=(0,tslib_1.__importDefault)(require("./targets")),utils_1=require("../../utils"),HTTPSnippet=function(){function e(e){Object.defineProperty(this,"request",{enumerable:!0,configurable:!0,writable:!0,value:void 0});var t=(0,tslib_1.__assign)({},e);this.request=this.prepare((0,tslib_1.__assign)((0,tslib_1.__assign)({},t),{httpVersion:t.httpVersion||"HTTP/1.1",queryString:t.queryString||[],headers:t.headers||[],cookies:t.cookies||[],postData:t.postData?(0,tslib_1.__assign)((0,tslib_1.__assign)({},t.postData),{jsonObj:void 0,paramsObj:void 0}):void 0,bodySize:0,headersSize:0,queryObj:{},headersObj:{},cookiesObj:{},allHeaders:{},uriObj:{},fullUrl:"",pathParameters:t.pathParameters||{},serverVariables:t.serverVariables||{}}))}return Object.defineProperty(e.prototype,"prepare",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t;if(e.queryString&&e.queryString.length&&(e.queryObj=e.queryString.reduce(reducer_1.default,{})),e.headers&&e.headers.length){var r=/^HTTP\/2/;e.headersObj=e.headers.reduce((function(t,a){var i=a.name;return e.httpVersion.match(r)&&(i=i.toLowerCase()),t[i]=a.value,t}),{})}e.cookies&&e.cookies.length&&(e.cookiesObj=e.cookies.reduceRight((function(e,t){return e[t.name]=t.value,e}),{}));var a=e.cookies.map((function(e){return encodeURIComponent(e.name)+"="+encodeURIComponent(e.value)}));if(a.length&&(e.allHeaders.cookie=a.join("; ")),e.postData)switch((0,utils_1.normalizeMimeType)(e.postData.mimeType)){case"multipart/mixed":case"multipart/related":case"multipart/form-data":case"multipart/alternative":break;case"application/x-www-form-urlencoded":(null===(t=e.postData)||void 0===t?void 0:t.params)?(e.postData.paramsObj=e.postData.params.reduce(reducer_1.default,{}),e.postData.text=qs.stringify(e.postData.paramsObj)):e.postData.text="";break;case"text/json":case"text/x-json":case"application/json":case"application/x-json":if(e.postData.mimeType="application/json",e.postData.text)try{e.postData.jsonObj=JSON.parse(e.postData.text)}catch(t){e.postData.mimeType="text/plain"}}return e.allHeaders=Object.assign(e.allHeaders,e.headersObj),e.uriObj=url.parse(e.url,!0,!0),e.queryObj=Object.assign(e.queryObj,e.uriObj.query),e.uriObj.query=null,e.uriObj.search=null,e.uriObj.path=e.uriObj.pathname=(0,utils_1.unescapeServerVariables)(e.uriObj.pathname),e.url=(0,utils_1.unescapeServerVariables)(url.format(e.uriObj)),e.uriObj.query=e.queryObj,e.uriObj.search=qs.stringify(e.queryObj),e.uriObj.search&&(e.uriObj.path=e.uriObj.pathname+"?"+e.uriObj.search),e.fullUrl=(0,utils_1.unescapeServerVariables)(url.format(e.uriObj)),e}}),Object.defineProperty(e.prototype,"convert",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t,r){!r&&t&&(r=t);var a=this._matchTarget(e,t);if(a){var i=a(this.request,r,{target:e,client:t});return 1===i.length?i[0]:i}throw new Error("Can not match target")}}),Object.defineProperty(e.prototype,"_matchTarget",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){return!!Object.prototype.hasOwnProperty.call(targets_1.default,e)&&("string"==typeof t&&"function"==typeof targets_1.default[e][t]?targets_1.default[e][t]:targets_1.default[e][targets_1.default[e].info.default])}}),e}();exports.HTTPSnippet=HTTPSnippet;
//# sourceMappingURL=index.js.map