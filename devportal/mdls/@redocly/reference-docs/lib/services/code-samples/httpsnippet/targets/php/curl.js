"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.info=void 0;var tslib_1=require("tslib"),util_1=require("util"),code_builder_1=require("../../helpers/code-builder"),__1=require("../.."),constants_1=require("../../helpers/constants"),code_helpers_1=require("../../helpers/code-helpers"),lodash_int_1=require("../../helpers/lodash-int"),utils_1=require("../../../../utils"),utils_2=require("./utils");function getVariableName(e,a){return a?"$"+a+(0,lodash_int_1.startCase)(e):"$"+e}var handler=function(e,a,r){var s,t,n=r.target,i=r.client,l=(0,tslib_1.__assign)({showBoilerplate:!0,checkErrors:!1,printBody:!0,indent:"  ",noTags:!0,shortTags:!1,maxRedirects:10,namedErrors:!1,closingTag:!1},a),o=!1,u=new code_builder_1.CodeBuilder({indentation:l.indent,capitalize:!0,lang:constants_1.Lang.PHP}),p=null===(s=e.securityOAuth2ExtraCalls)||void 0===s?void 0:s[0],c=getVariableName("curl",l.variablesPrefix),h=getVariableName("response",l.variablesPrefix),d=getVariableName("error",l.variablesPrefix);if(l.noTags||u.push(l.shortTags?"<?":"<?php").blank(),p){var _="oAuth2",b=new __1.HTTPSnippet(p).convert(n,i,(0,tslib_1.__assign)((0,tslib_1.__assign)({},l),{showBoilerplate:!1,variablesPrefix:_}));u.push(b),u.blank(),e.allHeaders.Authorization='Bearer " . '+getVariableName("response",_)+".access_token"}var m=Object.keys(e.headersObj).sort().map((function(a){return"Authorization"===a&&p?(0,util_1.format)('"%s: %s',a,e.allHeaders.Authorization):(0,util_1.format)('"%s: %s"',a,e.headersObj[a])}));if(e.basicAuth){var v=e.basicAuth,f=v.username,T=v.password;m.push('"Authorization: Basic " . base64_encode("'+f+":"+T+'")')}l.showBoilerplate&&u.push("/**").push(" * Requires libcurl").push(" */").blank(),(0,code_helpers_1.printUrlVariablesDeclarations)(e,u);var g="";if(Object.keys(e.queryObj||{}).length){var P=(0,utils_2.objectToPhpArray)(e.queryObj||{},{indent:l.indent});g="$query",u.push(g+" = "+P+";").blank()}if(u.push(c+" = curl_init();"),u.blank(),e.postData)switch((0,utils_1.normalizeMimeType)(e.postData.mimeType)){case"application/json":var y=(0,utils_2.objectToPhpArray)(e.postData.jsonObj||{},{indent:l.indent});o=!0,t="json_encode($payload)",u.push("$payload = "+y+";").blank();break;case"multipart/form-data":var k=e.postData.params.map((function(e){var a=e.name,r=e.value;return l.indent+'"'+a+'" => "'+r+'",\n'})).join("");o=!0,t="$payload",u.push("$payload = array(\n"+k+");").blank();break;case"application/x-www-form-urlencoded":var O=e.postData.params.map((function(e){return e.name+"="+e.value})).join("&");o=!0,t="$payload",u.push('$payload = "'+O+'";').blank();break;default:t=e.postData.text}var R=(0,code_helpers_1.buildUrlExpression)(e,u);g&&(R.endsWith('"')?R=R.slice(0,-1)+'?" . http_build_query('+g+")":R+=' . "?" . http_build_query('+g+")");var j=[{escape:!o,name:"CURLOPT_POSTFIELDS",value:t},{escape:!0,name:"CURLOPT_PORT",value:e.uriObj.port},{escape:!1,name:"CURLOPT_URL",value:R},{escape:!1,name:"CURLOPT_RETURNTRANSFER",value:"true"},{escape:!0,name:"CURLOPT_CUSTOMREQUEST",value:e.method.toUpperCase()}];u.push("curl_setopt_array("+c+", [");var U=new code_builder_1.CodeBuilder({indentation:l.indent,lineJoin:"\n"+l.indent,variablesPrefix:l.variablesPrefix,capitalize:!0,lang:constants_1.Lang.PHP});m.length&&U.push("CURLOPT_HTTPHEADER => [").push(1,m.join(",\n"+l.indent+l.indent)).push("],"),j.forEach((function(e){[null,void 0].includes(e.value)||U.push((0,util_1.format)("%s => %s,",e.name,e.escape?JSON.stringify(e.value):e.value))}));var x=e.cookies.map((function(e){return encodeURIComponent(e.name)+"="+encodeURIComponent(e.value)}));return x.length&&U.push((0,util_1.format)('CURLOPT_COOKIE => "%s",',x.join("; "))),u.push(1,U.join()).push("]);").blank().push(h+" = curl_exec("+c+");").push(d+" = curl_error("+c+");").blank().push("curl_close("+c+");").blank().push("if ("+d+") {"),l.namedErrors?u.push(1,'echo array_flip(get_defined_constants(true)["curl"])['+d+"];"):u.push(1,'echo "cURL Error #:" . '+d+";"),u.push("} else {").push(1,"echo "+h+";").push("}"),!l.noTags&&l.closingTag&&u.blank().push("?>"),u.join()};exports.info={key:"curl",title:"cURL",link:"http://php.net/manual/en/book.curl.php",description:"PHP with ext-curl"},exports.default=handler;
//# sourceMappingURL=curl.js.map